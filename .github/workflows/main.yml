name: Deploy to cloudtype
on:
  push:
    branches:
      - master
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Connect deploy key
        uses: cloudtype-github-actions/connect@v1
        with:
          token: ${{ secrets.CLOUDTYPE_TOKEN }}
          ghtoken: ${{ secrets.GHP_TOKEN }}
      - name: Deploy
        uses: cloudtype-github-actions/deploy@v1
        with:
          token: ${{ secrets.CLOUDTYPE_TOKEN }}
          project: oiehomail/backend
          stage: frontend
          yaml: |
            name: portfolio-v2-frontend
            app: web
            options:
              nodeversion: "18"
              docbase: /build
              spa: true
              build: npm run build
              buildenv:
                - name: REACT_APP_WAITLIST_API_URL
                  value: portfolio-v2-frontend:80/api/guests
            context:
              git:
                url: git@github.com:${{ github.repository }}.git
                ref: ${{ github.ref }}
              preset: react
          
      - name: Deploy
        uses: cloudtype-github-actions/deploy@v1
        with:
          run: sleep 200s
          shell: bash
          token: ${{ secrets.CLOUDTYPE_TOKEN }}
          project: oiehomail/backend
          stage: frontend
          yaml: >
            name: nginx

            app: nginx@1.24

            options:
              config: |-
                worker_processes auto;
                events {}

                http {
                  include /etc/nginx/mime.types;
                  gzip on;

                  server {
                    location = / {
                        # / 요청은 frontend 로 프록시
                        proxy_pass http://portfolio-v2-frontend:80;
                        proxy_set_header Host $host;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    }

                    location /static/ {
                        # /static/ 경로에 대한 요청은 frontend 로 프록시
                        proxy_pass http://portfolio-v2-frontend:80;
                        proxy_set_header Host $host;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    }

                    location / {
                        # 기타 요청은 backend 로 프록시
                        proxy_pass http://portfolio-v2-backend:8088;
                        proxy_set_header Host $host;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    }
                  }
                }
            context:
              preset: nginx
              git:
                url: git@github.com:${{ github.repository }}.git
                ref: ${{ github.ref }}
